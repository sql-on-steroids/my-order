# My Order - система обработки заказов клиентов
*Небольшая система размещения заказов от покупателей компании, написанная на языке lsFusion*

My Order - это приложение для платформы [lsFusion](https://lsfusion.org), позволяющее в небольшой торговой компании быстро организовать сбор и обработку заказов через Интернет от авторизованных клиентов и "полевых" продавцов. My Order обладает только самыми базовыми функциями [систем ORM](https://en.wikipedia.org/wiki/Order_management_system), и позволяет:
* загрузить из таблицы Excel или файла JSON каталог товаров компании с розничным прайсом,
* загрузить также список контрагентов-покупателей, от имени которых будут размещаться заказы в системе,
* завести в систему пользователей, назначить им роли (администратор, клиент, продавец компании), для клиентов указать контрагента, которого они представляют,
* организовать экспорт заполненных заказов в файлы формата JSON, для дальнейшей загрузки в вашу учётную систему,
* организовать импорт из системы управленческого учёта компании результатов обработки заказов, а также обновлений каталога товаров с ценами и списка покупателей,
* отображать для пользователей статус размещённых ими заказов.

## Приложения, требуемые для развёртывания системы заказов My Order

My Order требует, чтобы на компьютере предварительно была установлена и настроена [платформа lsFusion версии 2.0 или выше](https://documentation.lsfusion.org/pages/viewpage.action?pageId=18645035). Вы можете использовать любой из предложенных вариантов установки:
* ["Автоматическая установка для выполнения"](https://documentation.lsfusion.org/pages/viewpage.action?pageId=57738078) - если хотите только посмотреть её в работе.
* ["Автоматическая установка для разработки"](https://documentation.lsfusion.org/pages/viewpage.action?pageId=57738076) - позволит быстро установить платформу lsFusion, а также разобраться в её исходном коде, используя IntelliJ IDEA.
* Либо самостоятельно установить требуемые для запуска платформы приложения.

## Установка My Order (вариант "Установка для разработки")

Если вы выбрали вариант с установкой для разработки:
* Запустите IDEA.
* В меню выберите File - New - Project from Version Control... - Git.
* В URL укажите этот репозиторий: `https://github.com/sql-on-steroids/my-order.git` а в Directory - папку для размещения проекта My Order.
Проект My Order будет загружен на компьютер и открыт в IDEA.

## Установка My Order (вариант "Установка для выполнения")

Если вы выбрали вариант с установкой для выполнения:

* Скачайте ZIP-архив с приложением My Order с GitHub.
* Файлы с типом .LSF из папки `src\main\lsfusion` архива поместите в папку `lib` установленного сервера приложений lsFusion.
* Файл settings.properties из папки `conf` архива поместите в папку `conf` сервера приложений lsFusion. __Внимание:__ сделайте копию файла настроек settings.properties, который там был создан при установке lsFusion, а также перенесите оттуда в новый файл настройки для доступа к СУБД PostgreSQL.

Это лишь краткая информация по установке и настройке. Пожалуйста, руководствуйтесь инструкциями в документации lsFusion во избежание ошибок: https://documentation.lsfusion.org/pages/viewpage.action?pageId=57738078

## Настройка и запуск сервера приложений lsFusion

Если установка платформы lsFusion и приложения My Order была произведена правильно, можно его запустить в IDEA, либо через командную строку, как указано в [документации](https://documentation.lsfusion.org/pages/viewpage.action?pageId=18645035). При первом запуске сервера приложений lsFusion с My Order он создаст базу данных приложения в СУБД PostgreSQL.

__Внимание:__ При первом запуске обязательно нужно убрать птичку Light start сервера приложений. В IDEA она находится в меню Run - Edit Configurations - Configuration. Это необходимо, чтобы сервер просканировал и запомнил структуру My Order.

После успешной первой загрузки сервера приложений его необходимо остановить, и запустить повторно. При второй загрузке в приложении будут созданы роли пользователей, назначены права, и сделаны начальные настройки. Используя десктопный или Web-клиент lsFusion вы сможете войти в приложение My Order. Введите имя пользователя `admin` без пароля для входа.

## Настройка системы заказов My Order

Если предыдущие шаги были сделаны правильно, перед вами откроется окно приложения My Order в браузере или десктопном клиенте. Вверху окна в навигаторе должны быть следующие пункты: Администрирование, Настройка программы, Заказы покупателей, Учётная запись. Вначале откройте меню Администрирование - Доступ - Политика безопасности, закладка Роли, и проверьте наличие ролей Администратор, Клиент и Продавец. Если их нет, перезапустите сервер приложений заново. Если они не появятся - значит, настройка не была завершена правильно, и нужно свериться с документацией lsFusion.

Откройте в Администрировании меню Доступ - Пользователи, добавьте пользователей в систему, назначьте каждому главную роль.

В верхнем меню навигатора в Настройках программы укажите папку для обмена с вашей учётной системой (например, `d:/MyOrder/Exchange`). После сохранения настроек в ней появятся подпапки:
* `d:/MyOrder/Exchange/out` -- для заказов покупателей, направляемых в систему управленческого учёта (файлы типа `order 2019-10-30 02-15-22.json`).
* `d:/MyOrder/Exchange/in` -- для входящих сообщений от системы управленческого учёта (файлы `catalog.xlsx`, `customer.xlsx`, `order result NNNN.json` и т.п.).
* `d:/MyOrder/Exchange/in/bad` -- сюда My Order будет помещать нераспознанные сообщения от системы учёта.
* `d:/MyOrder/Exchange/in/ok` -- а сюда - принятые и обработанные сообщения от системы учёта.

В этой же форме позже можно будет назначить каждому клиенту компанию контрагента-покупателя, которую он представляет. Также продавцам своей компании можно указать покупателя по-умолчанию, с котором он чаще работает.

В меню Администрирование - Система - Планировщик - Задания проверьте наличие задания "Импорт из 1С". Там же можно изменить период проверки папки обмена на наличие сообщений от системы учёта (по-умолчанию - каждые 30 сек.).

## Использование системы заказов My Order

Для начального тестирования системы заказов можно воспользоваться подготовленными заранее списком покупателей и каталогом товаров. Они находятся в поставке My Order в папке `docs`. Просто скопируйте файлы `customer.xlsx` и `catalog.xlsx` в папку обмена `d:/MyOrder/Exchange/in`, и в течение полуминуты они будут обработаны и загружены в базу программы.

Сейчас можно зайти в систему под любым заведённым в неё пользователем, и проверить как она выглядит для администратора, клиента компании, или её продавца. Основная рабочая форма клиента компании - это Заказы покупателей. Здесь можно добавлять, редактировать, удалять заказы, а также отправлять их поставщику. Здесь же можно следить за статусом отправленных заказов, увидеть время принятия поставщиком или причину отказа. Используйте мощную систему фильтров lsFusion и поиск по наименованию для быстрого выбора нужного товара из списка.

## Исходный код проекта

Вся логика приложения, описание предметной области и общение с базой данных содержится в папке `src/main/lsfusion` в 6 файлах, написанных исключительно на языке lsFusion:
* Main.lsf - главный файл приложения, который содержит ссылки на все остальные файлы, и содержит код для начальной настройки пользователей, ролей и связей с системой учёта.
* Data.lsf - файл с описанием структуры бизнес-классов и их свойств, основные формы для редактирования, просмотра и выбора бизнес-объектов, код для поддержания логической целостности информации.
* Settings.lsf - форма настроек приложения My Order.
* Export.lsf - экспорт набранных заказов в систему учёта предприятия.
* Import.lsf - загрузка и обработка сообщений от системы управленческого учёта.
Весь исходный код приложения - это примерно 500 строк, с пробелами и комментариями.

## Образцы файлов обмена

Для обмена информацией с системой учёта приложение My Order использует файлы форматов Excel (.XLSX, .XLS) и JSON. Но платформа позволяет с небольшой доработкой принимать также файлы форматов CSV, XML, а также использовать разнообразные [API](https://documentation.lsfusion.org/pages/viewpage.action?pageId=29884429). Образцы файлов импорта/экспорта есть в папке `docs` этого проекта.

Система My Order бесплатна и распространяется со всеми исходными модулями .LSF. Благодаря модульности, хорошей расширяемости и широким возможностям, предоставляемым платформой lsFusion, эту систему заказов можно использовать как базу для наращивания функционала и разработки собственной системы ORM, настроенной на бизнес-процессы вашей компании или компании-заказчика.

Спасибо тем, кто дочитал инструкцию до конца, и желаю вам успешных внедрений!

(C) 2019 Kryvich.
